// 1D Gaussian Filter
// Reference: http://prideout.net/bloom/index.php

varying vec2 texCoord;
varying vec2 texCoord2;
uniform float ssaoRescale;
uniform sampler2DRect texSSAO;	// SSAO result texture
uniform sampler2DRect texNormal;// Normal texture
uniform vec2 blurDirection;

vec3 thisNormal = texture2DRect(texNormal, texCoord).xyz;
float thisValue;
float totalWeight = 0.0;
float doSum(float weight, float offset)
{
	vec3 normal = texture2DRect(texNormal, texCoord2 + blurDirection * (offset / ssaoRescale)).xyz * 2.0 - 1.0;
	float value = texture2DRect(texSSAO, texCoord + blurDirection * offset).r;
	float w = dot(normal, thisNormal);// * weight;

	totalWeight += w;
	return w * value;
}

void main(void)
{
	float sum = 0.0;

	// No filtering
//	gl_FragColor = texture2DRect(texSSAO, texCoord);

	// Filter size = 5
/*	sum += 1.0 * texture2DRect(texSSAO, texCoord - blurDirection * 2.0).r;
	sum += 4.0 * texture2DRect(texSSAO, texCoord - blurDirection * 1.0).r;
	sum += 6.0 * texture2DRect(texSSAO, texCoord - blurDirection * 0.0).r;
	sum += 4.0 * texture2DRect(texSSAO, texCoord + blurDirection * 1.0).r;
	sum += 1.0 * texture2DRect(texSSAO, texCoord + blurDirection * 2.0).r;

	gl_FragColor = vec4(vec3(sum * 0.0625), 1.0);	// 1/16 = 0.0625*/

	// Filter size = 7
/*	sum +=  1.0 * texture2DRect(texSSAO, texCoord - blurDirection * 3.0).r;
	sum +=  6.0 * texture2DRect(texSSAO, texCoord - blurDirection * 2.0).r;
	sum += 15.0 * texture2DRect(texSSAO, texCoord - blurDirection * 1.0).r;
	sum += 20.0 * texture2DRect(texSSAO, texCoord - blurDirection * 0.0).r;
	sum += 15.0 * texture2DRect(texSSAO, texCoord + blurDirection * 1.0).r;
	sum +=  6.0 * texture2DRect(texSSAO, texCoord + blurDirection * 2.0).r;
	sum +=  1.0 * texture2DRect(texSSAO, texCoord + blurDirection * 3.0).r;

	gl_FragColor = vec4(vec3(sum * 0.015625), 1.0);	// 1/64 = 0.015625*/

	// Filter size = 7
	thisValue = texture2DRect(texSSAO, texCoord).r;
	thisNormal = texture2DRect(texNormal, texCoord2).xyz * 2.0 - 1.0;

	sum += doSum( 1.0, -3.0);
	sum += doSum( 6.0, -2.0);
	sum += doSum(15.0, -1.0);
	sum += doSum(20.0,  0.0);
	sum += doSum(15.0,  1.0);
	sum += doSum( 6.0,  2.0);
	sum += doSum( 1.0,  3.0);
	if(sum == 0.0) {
		sum = texture2DRect(texSSAO, texCoord - vec2(0.5)).r;
		totalWeight = 1.0;
	}
	gl_FragColor = vec4(vec3(sum / totalWeight), 1.0);
}
